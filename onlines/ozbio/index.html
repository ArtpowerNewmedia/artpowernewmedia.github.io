<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preload" href="01.jpg" as="image">
    <link rel="preload" href="02.png" as="image">
    <link rel="preload" href="03.png" as="image">
    <link rel="preload" href="04.png" as="image">
    <title>化身益菌探險家</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background-color: #000;
            /* 隱藏卷軸 */
            overflow: hidden;
        }

        .camera-container {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #1b0533;
        }

        .camera-transform {
            position: absolute;
            height: 40%;
            aspect-ratio: 1 / 1;
            object-fit: cover;
            left: 50%;
            top: 15.5%;
            transform: translate(-50%, 0%) scaleX(-1);
        }

        @supports (height: 40dvh) {
            .camera-transform {
                position: absolute;
                width: 40dvh;
                height: 40dvh;
                object-fit: cover;
                left: 50%;
                top: 15.5dvh;
                transform: translate(-50%, 0%) scaleX(-1);
            }
        }

        .camera-transform.hidden {
            display: none;
        }

        .background-container {
            position: absolute;
            height: 100%;
            width: 100%;
            max-width: 100vh;
            left: 50%;
            transform: translateX(-50%);
            background-image: url('01.jpg');
            background-size: cover;
            background-position: center;
            opacity: 1;
            pointer-events: none;
        }

        .form-container {
            position: absolute;
            background: rgba(255, 255, 255, 0.0);
            width: 38vh;
            top: 50%;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-input {
            width: 100%;
            padding: 12px 12px;
            border: 2px solid rgb(103, 192, 158);
            border-radius: 15px;
            font-size: 2vh;
            font-weight: 800;
            background: #ffffff;
            color: #00825E;
            transition: border-color 0.3s ease;

            &::placeholder {
                color: #17684285;
            }
        }

        .form-input:focus {
            outline: none;
            border-color: #4a7c59;
            box-shadow: 0 0 0 3px rgba(45, 90, 45, 0.1);
        }

        .submit-btn {
            width: 18vh;
            height: 6vh;
            background-image: url('btn_send.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: transparent;
            border: none;
            display: block;
            margin: 0 auto;
            cursor: pointer;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .submit-btn:active {
            transform: translateY(2px);
        }

        .camera-work-container {
            position: absolute;
            top: 73%;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: auto;
        }

        .camera-work-btn {
            width: 10vh;
            height: 10vh;
            background-image: url('btn_camera.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: transparent;
            border: none;
            display: block;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: box-shadow 0.3s ease;
        }

        .camera-work-btn:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }

        .camera-work-btn:active {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transform: translateY(1px);
        }

        .camera-confirm-container {
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translateX(-50%);
            width: 15vh;
            pointer-events: auto;
        }

        .camera-confirm-btn {
            width: 15vh;
            height: 5vh;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: transparent;
            border: none;
            cursor: pointer;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
            transition: filter 0.3s ease;
            margin-bottom: 5vh;
        }

        .camera-confirm-btn.confirm {
            background-image: url('btn_confirm.png');
        }
        .camera-confirm-btn.ng {
            background-image: url('btn_reshot.png');
        }

        .camera-confirm-btn:hover {
            filter: drop-shadow(0 6px 12px rgba(0, 0, 0, 0.4));
        }

        .camera-confirm-btn:active {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            transform: translateY(1px);
        }

        .result-container {
            position: absolute;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: none;
        }

        .result-canvas {
            position: absolute;
            width: 100%;
            max-width: 60vh;
            height: 100%;
            left: 50%;
            transform: translate(-50%, 0%);
            object-fit: cover;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* 手機直式模式特殊處理
        @media screen and (orientation: portrait) and (max-width: 768px) {
            .background-container {
                background-size: cover;
                background-position: center;
                width: 100vh;
                height: 100vh;
            }
        } */
    </style>
</head>
<body>

    <div class="camera-container">
        <video id="camera" autoplay playsinline class="camera-transform"></video>
        <canvas id="canvas" class="camera-transform hidden"></canvas>
    </div>

    <div class="result-container">
        <img id="result-canvas" class="result-canvas">
    </div>

    <div class="background-container">
        <div class="form-container">
            <div class="form-group">
                <input type="text" class="form-input" placeholder="姓名">
            </div>
            
            <div class="form-group">
                <input type="text" class="form-input" placeholder="公司名稱">
            </div>
            
            <div class="form-group">
                <input type="tel" class="form-input" placeholder="電話">
            </div>
            <button type="submit" class="submit-btn" onclick="submitForm()"></button>
        </div>

        <div class="camera-work-container">
            <button class="camera-work-btn" onclick="submitCamera()"></button>
        </div>

        <div class="camera-confirm-container">
            <button class="camera-confirm-btn confirm" onclick="submitOK()"></button>
            <button class="camera-confirm-btn ng" onclick="submitNG()"></button>
        </div>
    </div>
        
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        //const socket  = io('https://192.168.50.28:3000');
        const socket  = io('https://nodeozbio-production.up.railway.app/');
        var formData = {};
        var captureData = {};
        

        // 頁面切換器
        function switchPage(pageName) {
            const backgroundContainer = document.querySelector('.background-container');
            const formContainer = document.querySelector('.form-container');
            const cameraWorkContainer = document.querySelector('.camera-work-container');
            const confirmContainer = document.querySelector('.camera-confirm-container');

            const canvas = document.getElementById('canvas');
            
            // 重置所有顯示狀態
            formContainer.style.display = 'none';
            cameraWorkContainer.style.display = 'none';
            confirmContainer.style.display = 'none';

            // 重置相機元素狀態
            canvas.classList.add('hidden');
            
            // 預先設定背景圖片，避免載入延遲
            const backgroundImages = {
                'form': '01.jpg',
                'camera': '02.png',
                'confirm': '03.png',
                'result': '04.png'
            };
            
            // 立即設定背景圖片
            if (backgroundImages[pageName]) {
                backgroundContainer.style.backgroundImage = `url(${backgroundImages[pageName]})`;
            }
            
            switch(pageName) {
                case 'form':
                    formContainer.style.display = 'block';
                    break;
                    
                case 'camera':
                    cameraWorkContainer.style.display = 'block';
                    break;
                    
                case 'confirm':
                    confirmContainer.style.display = 'block';
                    canvas.classList.remove('hidden');
                    break;
                    
                case 'result':
                    // 顯示 result-container
                    const resultContainer = document.querySelector('.result-container');
                    resultContainer.style.display = 'block';
                    
                    // 載入影像到 result-canvas（可以根據需求修改路徑）
                    //loadImageToResultCanvas('result_preview.jpg');
                    break;
                    
                default:
                    console.error('未知的頁面名稱:', pageName);
            }
        }

        // 預載入背景圖片
        function preloadBackgroundImages() {
            const imageUrls = [
                '01.jpg',
                '02.png', 
                '03.png',
                '04.png',
                '確認頁.jpg'
            ];
            
            const preloadedImages = [];
            
            imageUrls.forEach((url, index) => {
                const img = new Image();
                img.onload = function() {
                    console.log('圖片預載入完成:', url);
                    preloadedImages[index] = img;
                };
                img.onerror = function() {
                    console.error('圖片預載入失敗:', url);
                };
                img.src = url;
            });
            
            return preloadedImages;
        }

        // 測試用，載入頁面時自動送出表單
        window.onload = function() {
            formData = {name: 'testName', company: 'testCompany', phone: 'testPhone'};
            
            // 預載入背景圖片
            //preloadBackgroundImages();
            
            switchPage('form');
            
            // 初始化長按保存功能
            setupLongPressSave();
        }

        // 接收照片事件
        socket.on('masterAction', (data) => {
            try {
                console.log(`收到照片，UUID: ${data.uuid}`);
                console.log('接收到的資料類型:', typeof data.imageData);
                console.log('接收到的資料結構:', data.imageData);
                console.log('資料長度:', data.imageData ? data.imageData.length : 'undefined');
                
                // 處理不同可能的資料格式
                let imageArray;
                
                if (Array.isArray(data.imageData)) {
                    // 如果已經是陣列，直接使用
                    imageArray = data.imageData;
                    console.log('使用陣列格式');
                } else if (data.imageData && typeof data.imageData === 'object') {
                    // 如果是物件，可能是序列化後的格式
                    // 嘗試轉換為陣列
                    imageArray = Object.values(data.imageData);
                    console.log('轉換物件為陣列');
                } else if (typeof data.imageData === 'string') {
                    // 如果是字串，可能是 base64 格式
                    console.log('檢測到字串格式，可能是 base64');
                    const imageUrl = `data:image/png;base64,${data.imageData}`;
                    document.getElementById('result-canvas').src = imageUrl;
                    return;
                } else {
                    throw new Error(`不支援的資料格式: ${typeof data.imageData}`);
                }
                
                // 確保所有元素都是數字
                if (!imageArray.every(item => typeof item === 'number' && item >= 0 && item <= 255)) {
                    throw new Error('陣列包含無效的位元組值');
                }
                
                // 將 byte array 轉換為 base64
                let base64String;
                try {
                    // 方法1: 使用 apply (適用於較小的陣列)
                    if (imageArray.length <= 65536) {
                        base64String = btoa(String.fromCharCode.apply(null, imageArray));
                    } else {
                        // 方法2: 對於大陣列，分段處理
                        const chunks = [];
                        for (let i = 0; i < imageArray.length; i += 65536) {
                            const chunk = imageArray.slice(i, i + 65536);
                            chunks.push(String.fromCharCode.apply(null, chunk));
                        }
                        base64String = btoa(chunks.join(''));
                    }
                } catch (applyError) {
                    // 方法3: 如果 apply 失敗，使用 Uint8Array
                    console.log('apply 方法失敗，使用 Uint8Array 方法');
                    const uint8Array = new Uint8Array(imageArray);
                    const binaryString = Array.from(uint8Array, byte => String.fromCharCode(byte)).join('');
                    base64String = btoa(binaryString);
                }
                
                const imageUrl = `data:image/png;base64,${base64String}`;
                
                // 顯示照片
                document.getElementById('result-canvas').src = imageUrl;
                console.log('照片處理完成');
                
            } catch (error) {
                console.log(`處理照片時發生錯誤: ${error.message}`);
                console.error('完整錯誤:', error);
                console.error('錯誤堆疊:', error.stack);
            }
        });

        // 送出表單
        function submitForm() {
            // 只有在formData沒有值時才從input獲取值
            if (!formData.name) {
                formData.name = document.querySelectorAll('.form-input')[0].value;
                formData.company = document.querySelectorAll('.form-input')[1].value;
                formData.phone = document.querySelectorAll('.form-input')[2].value;
            }

            switchPage('camera');
            startCamera();
            console.log(formData);
        }

        function submitCamera() {
            const canvas = document.getElementById('canvas');
            const video = document.getElementById('camera');
            
            // 設定 canvas 尺寸
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            
            // 繪製當前視訊畫面到 canvas
            ctx.drawImage(video, 0, 0);

            captureData = canvas.toDataURL('image/png');
            
            // 顯示 canvas
            canvas.classList.remove('hidden');
            
            switchPage('confirm');
        }

        function takeSnapshot () {
            const video = document.getElementById('camera');
            const canvas = document.createElement('canvas');
            canvas.width  = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            return canvas.toDataURL('image/png');           // 產生 base64
        }

        function submitOK() {
            // 儲存影像
            //const imageData = takeSnapshot();
            console.log('儲存影像:', captureData);
            
            // 這裡可以加入將影像傳送到伺服器的程式碼
            // 例如：sendImageToServer(imageData);
            socket.emit('photo', { dataUrl: captureData });
            
            switchPage('result');
            stopCamera();
        }

        function submitNG() {
            // 隱藏 canvas
            const canvas = document.getElementById('canvas');
            canvas.classList.add('hidden');
            
            switchPage('camera');
        }

        // 啟動前鏡頭
        async function startCamera() {
            try {
                const video = document.getElementById('camera');
                
                // 檢查是否支援 getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('瀏覽器不支援相機功能');
                }
                
                // 先嘗試前鏡頭
                let stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'user'  // 移除 exact 限制
                    },
                    audio: false
                });
                
                video.srcObject = stream;
                video.play();
                
            } catch (err) {
                console.error('相機存取錯誤:', err);
                
                // 如果是權限錯誤，提供替代方案
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert('相機權限被拒絕。\n\n解決方案：\n1. 重新整理頁面並允許權限\n2. 不要透過通訊軟體(Line、FB)開啟連結\n3. 若是電腦版，點擊網址列左側的鎖頭圖示，允許相機權限');
                    return;
                }
                
                // 如果是 HTTPS 錯誤，提供替代方案
                if (err.name === 'NotSupportedError' && location.protocol === 'http:') {
                    alert('相機功能需要 HTTPS 連線。\n\n解決方案：\n1. 使用 ngrok 提供的 HTTPS 網址\n2. 或使用模擬相機功能進行測試');
                    return;
                }
                
                // 如果前鏡頭失敗，嘗試後鏡頭
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment'
                        },
                        audio: false
                    });
                    
                    const video = document.getElementById('camera');
                    video.srcObject = stream;
                    video.play();
                    
                } catch (err2) {
                    console.error('後鏡頭也失敗:', err2);
                    alert('無法存取相機，請確認已授權相機權限。\n錯誤：' + err.message);
                }
            }
        }

        function stopCamera() {
            const video = document.getElementById('camera');
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
            video.classList.add('hidden');
        }

        // 讀取並顯示 PNG 影像到 result-canvas
        function loadImageToResultCanvas(imagePath) {
            const canvas = document.getElementById('result-canvas');
            const ctx = canvas.getContext('2d');
            
            // 創建新的影像物件
            const img = new Image();
            
            img.onload = function() {
                // 設定 canvas 尺寸為影像尺寸
                canvas.width = img.width;
                canvas.height = img.height;
                
                // 清除 canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 繪製影像到 canvas
                ctx.drawImage(img, 0, 0);
                
                console.log('影像已載入到 result-canvas:', imagePath);
                
                // 載入完成後轉換為 img 元素以支援原生長按保存
                setTimeout(() => {
                    convertCanvasToImage();
                }, 100);
            };
            
            img.onerror = function() {
                console.error('無法載入影像:', imagePath);
                alert('無法載入影像: ' + imagePath);
            };
            
            // 設定影像來源
            img.src = imagePath;
        }

        // 長按保存圖片功能
        function setupLongPressSave() {
            const canvas = document.getElementById('result-canvas');
            let pressTimer = null;
            let isLongPress = false;
            const longPressDelay = 1000; // 1秒長按

            // 滑鼠事件（桌面版）
            canvas.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isLongPress = false;
                
                pressTimer = setTimeout(function() {
                    isLongPress = true;
                    saveCanvasAsImage();
                }, longPressDelay);
            });

            canvas.addEventListener('mouseup', function(e) {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            canvas.addEventListener('mouseleave', function(e) {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            // 觸摸事件（手機版）
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                isLongPress = false;
                
                pressTimer = setTimeout(function() {
                    isLongPress = true;
                    saveCanvasAsImage();
                }, longPressDelay);
            });

            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            canvas.addEventListener('touchcancel', function(e) {
                e.preventDefault();
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            // 防止觸摸滾動
            canvas.addEventListener('touchmove', function(e) {
                if (isLongPress) {
                    e.preventDefault();
                }
            });
        }

        // 保存 canvas 為圖片
        function saveCanvasAsImage() {
            const canvas = document.getElementById('result-canvas');
            
            // 檢查 canvas 是否有內容
            if (canvas.width === 0 || canvas.height === 0) {
                alert('沒有可保存的圖片內容');
                return;
            }

            try {
                // 將 canvas 轉換為 blob
                canvas.toBlob(function(blob) {
                    // 創建下載連結
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'saved_image_' + new Date().getTime() + '.png';
                    
                    // 觸發下載
                    document.body.appendChild(a);
                    a.click();
                    
                    // 清理
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log('圖片已保存');
                }, 'image/png');
                
            } catch (error) {
                console.error('保存圖片時發生錯誤:', error);
                alert('保存圖片失敗: ' + error.message);
            }
        }

        // 將 canvas 轉換為 img 元素並啟用原生長按保存
        function convertCanvasToImage() {
            const canvas = document.getElementById('result-canvas');
            const resultContainer = document.querySelector('.result-container');
            
            // 檢查 canvas 是否有內容
            if (canvas.width === 0 || canvas.height === 0) {
                console.log('Canvas 沒有內容，無法轉換');
                return;
            }

            try {
                // 將 canvas 轉換為 data URL
                const dataURL = canvas.toDataURL('image/png');
                
                // 創建 img 元素
                const img = document.createElement('img');
                img.src = dataURL;
                img.className = 'result-canvas';
                img.alt = 'Result Image';
                
                // 隱藏 canvas，顯示 img
                canvas.style.display = 'none';
                resultContainer.appendChild(img);
                
                console.log('Canvas 已轉換為 img 元素，支援原生長按保存');
                
            } catch (error) {
                console.error('轉換 canvas 為 img 時發生錯誤:', error);
            }
        }

        // 混合方案：同時支援 canvas 和 img
        function setupHybridImageSave() {
            const canvas = document.getElementById('result-canvas');
            const resultContainer = document.querySelector('.result-container');
            
            // 創建一個隱藏的 img 元素作為備用
            const hiddenImg = document.createElement('img');
            hiddenImg.style.display = 'none';
            hiddenImg.id = 'hidden-result-img';
            resultContainer.appendChild(hiddenImg);
            
            // 當 canvas 有內容時，同步更新隱藏的 img
            const updateHiddenImage = () => {
                if (canvas.width > 0 && canvas.height > 0) {
                    try {
                        hiddenImg.src = canvas.toDataURL('image/png');
                    } catch (error) {
                        console.error('更新隱藏圖片時發生錯誤:', error);
                    }
                }
            };
            
            // 監聽 canvas 內容變化（這裡需要手動調用）
            window.updateHiddenImage = updateHiddenImage;
        }

        // 測試快捷鍵：按 q 鍵切換 background-container 顯示/隱藏
        document.addEventListener('keydown', function(event) {
            if (event.key === 'q' || event.key === 'Q') {
                const backgroundContainer = document.querySelector('.background-container');
                if (backgroundContainer.style.display === 'none') {
                    backgroundContainer.style.display = 'block';
                    console.log('background-container 已顯示');
                } else {
                    backgroundContainer.style.display = 'none';
                    console.log('background-container 已隱藏');
                }
            }
        });

        // 確保背景圖片在手機直式模式下正確顯示
        window.addEventListener('resize', function() {
            const container = document.querySelector('.background-container');
            if (window.innerHeight > window.innerWidth) {
                // 直式模式
                container.style.backgroundSize = 'cover';
                container.style.backgroundPosition = 'center';
            }
        });

        // 頁面載入時也執行一次
        window.addEventListener('load', function() {
            const container = document.querySelector('.background-container');
            if (window.innerHeight > window.innerWidth) {
                container.style.backgroundSize = 'cover';
                container.style.backgroundPosition = 'center';
            }
        });


    </script>
</body>
</html> 